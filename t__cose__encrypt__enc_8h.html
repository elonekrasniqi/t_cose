<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.9.8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>t_cose: inc/t_cose/t_cose_encrypt_enc.h File Reference</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectalign">
   <div id="projectname">t_cose
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.8 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search/",'.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

<div id="nav-path" class="navpath">
  <ul>
<li class="navelem"><a class="el" href="dir_bfccd401955b95cf8c75461437045ac0.html">inc</a></li><li class="navelem"><a class="el" href="dir_c790dd4d93afe6413732f56f53ec2af4.html">t_cose</a></li>  </ul>
</div>
</div><!-- top -->
<div class="header">
  <div class="summary">
<a href="#nested-classes">Data Structures</a> &#124;
<a href="#func-members">Functions</a>  </div>
  <div class="headertitle"><div class="title">t_cose_encrypt_enc.h File Reference</div></div>
</div><!--header-->
<div class="contents">

<p>Encrypt plaintext and encode it in a CBOR-based structure referred to as COSE_Encrypt0 or COSE_Encrypt.  
<a href="#details">More...</a></p>
<div class="textblock"><code>#include &lt;stdint.h&gt;</code><br />
<code>#include &lt;stdbool.h&gt;</code><br />
<code>#include &lt;stdlib.h&gt;</code><br />
<code>#include &quot;<a class="el" href="t__cose__parameters_8h_source.html">t_cose_parameters.h</a>&quot;</code><br />
<code>#include &quot;<a class="el" href="t__cose__key_8h_source.html">t_cose/t_cose_key.h</a>&quot;</code><br />
<code>#include &quot;<a class="el" href="t__cose__recipient__enc_8h_source.html">t_cose/t_cose_recipient_enc.h</a>&quot;</code><br />
</div>
<p><a href="t__cose__encrypt__enc_8h_source.html">Go to the source code of this file.</a></p>
<table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a id="nested-classes" name="nested-classes"></a>
Data Structures</h2></td></tr>
<tr class="memitem:"><td class="memItemLeft" align="right" valign="top">struct &#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="structt__cose__encrypt__enc.html">t_cose_encrypt_enc</a></td></tr>
<tr class="separator:"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table><table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a id="func-members" name="func-members"></a>
Functions</h2></td></tr>
<tr class="memitem:ae270e09acdbb973b45588bb52f546cf5" id="r_ae270e09acdbb973b45588bb52f546cf5"><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="t__cose__encrypt__enc_8h.html#ae270e09acdbb973b45588bb52f546cf5">t_cose_encypt_enc_init</a> (struct <a class="el" href="structt__cose__encrypt__enc.html">t_cose_encrypt_enc</a> *context, uint32_t option_flags, int32_t payload_cose_algorithm_id)</td></tr>
<tr class="memdesc:ae270e09acdbb973b45588bb52f546cf5"><td class="mdescLeft">&#160;</td><td class="mdescRight">Initialize to start creating a <code>COSE_Encrypt</code> structure.  <br /></td></tr>
<tr class="separator:ae270e09acdbb973b45588bb52f546cf5"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a77c7e6f3c82d76704e6f879a05ae786e" id="r_a77c7e6f3c82d76704e6f879a05ae786e"><td class="memItemLeft" align="right" valign="top">static void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="t__cose__encrypt__enc_8h.html#a77c7e6f3c82d76704e6f879a05ae786e">t_cose_encrypt_add_recipient</a> (struct <a class="el" href="structt__cose__encrypt__enc.html">t_cose_encrypt_enc</a> *context, struct <a class="el" href="structt__cose__recipient__enc.html">t_cose_recipient_enc</a> *recipient)</td></tr>
<tr class="memdesc:a77c7e6f3c82d76704e6f879a05ae786e"><td class="mdescLeft">&#160;</td><td class="mdescRight">Add a recipient to an existing COSE encrypt context. Information about a recipient needs to be provided.  <br /></td></tr>
<tr class="separator:a77c7e6f3c82d76704e6f879a05ae786e"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a71f21663f9a86bf74530ad019bb7865f" id="r_a71f21663f9a86bf74530ad019bb7865f"><td class="memItemLeft" align="right" valign="top">static void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="t__cose__encrypt__enc_8h.html#a71f21663f9a86bf74530ad019bb7865f">t_cose_encrypt_enc_body_header_params</a> (struct <a class="el" href="structt__cose__encrypt__enc.html">t_cose_encrypt_enc</a> *context, struct <a class="el" href="structt__cose__parameter.html">t_cose_parameter</a> *parameters)</td></tr>
<tr class="memdesc:a71f21663f9a86bf74530ad019bb7865f"><td class="mdescLeft">&#160;</td><td class="mdescRight">Add header parameters to the <code>COSE_Encrypt0</code> or <code>COSE_Encrypt</code> main body.  <br /></td></tr>
<tr class="separator:a71f21663f9a86bf74530ad019bb7865f"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:ae603f38c0f103d2c7be2a6d2316bd100" id="r_ae603f38c0f103d2c7be2a6d2316bd100"><td class="memItemLeft" align="right" valign="top">static void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="t__cose__encrypt__enc_8h.html#ae603f38c0f103d2c7be2a6d2316bd100">t_cose_encrypt_set_cek</a> (struct <a class="el" href="structt__cose__encrypt__enc.html">t_cose_encrypt_enc</a> *context, struct <a class="el" href="structt__cose__key.html">t_cose_key</a> cek)</td></tr>
<tr class="memdesc:ae603f38c0f103d2c7be2a6d2316bd100"><td class="mdescLeft">&#160;</td><td class="mdescRight">Set the content-encryption key, the CEK.  <br /></td></tr>
<tr class="separator:ae603f38c0f103d2c7be2a6d2316bd100"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a255aced5336f699201e8ed7db57e6803" id="r_a255aced5336f699201e8ed7db57e6803"><td class="memItemLeft" align="right" valign="top">static void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="t__cose__encrypt__enc_8h.html#a255aced5336f699201e8ed7db57e6803">t_cose_encrypt_set_enc_struct_buffer</a> (struct <a class="el" href="structt__cose__encrypt__enc.html">t_cose_encrypt_enc</a> *context, struct q_useful_buf enc_buffer)</td></tr>
<tr class="memdesc:a255aced5336f699201e8ed7db57e6803"><td class="mdescLeft">&#160;</td><td class="mdescRight">Setup buffer for larger externally supplied data or header parameters.  <br /></td></tr>
<tr class="separator:a255aced5336f699201e8ed7db57e6803"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a337c5145eeb638b5bb78ed592d6d5ea8" id="r_a337c5145eeb638b5bb78ed592d6d5ea8"><td class="memItemLeft" align="right" valign="top">static enum <a class="el" href="t__cose__common_8h.html#a469580b586841b779bbdc430d3a0dd97">t_cose_err_t</a>&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="t__cose__encrypt__enc_8h.html#a337c5145eeb638b5bb78ed592d6d5ea8">t_cose_encrypt_enc</a> (struct <a class="el" href="structt__cose__encrypt__enc.html">t_cose_encrypt_enc</a> *context, struct q_useful_buf_c payload, struct q_useful_buf_c ext_sup_data, struct q_useful_buf buffer_for_message, struct q_useful_buf_c *encrypted_message)</td></tr>
<tr class="memdesc:a337c5145eeb638b5bb78ed592d6d5ea8"><td class="mdescLeft">&#160;</td><td class="mdescRight">Create a <code>COSE_Encrypt</code> or <code>COSE_Encrypt0</code> structure and encrypt the provided plaintext.  <br /></td></tr>
<tr class="separator:a337c5145eeb638b5bb78ed592d6d5ea8"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a8d211229ffe582a97d1a003ea67b6511" id="r_a8d211229ffe582a97d1a003ea67b6511"><td class="memItemLeft" align="right" valign="top">enum <a class="el" href="t__cose__common_8h.html#a469580b586841b779bbdc430d3a0dd97">t_cose_err_t</a>&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="t__cose__encrypt__enc_8h.html#a8d211229ffe582a97d1a003ea67b6511">t_cose_encrypt_enc_detached</a> (struct <a class="el" href="structt__cose__encrypt__enc.html">t_cose_encrypt_enc</a> *context, struct q_useful_buf_c payload, struct q_useful_buf_c ext_sup_data, struct q_useful_buf buffer_for_detached, struct q_useful_buf buffer_for_message, struct q_useful_buf_c *encrypted_detached, struct q_useful_buf_c *encrypted_message)</td></tr>
<tr class="memdesc:a8d211229ffe582a97d1a003ea67b6511"><td class="mdescLeft">&#160;</td><td class="mdescRight">Create a <code>COSE_Encrypt</code> or <code>COSE_Encrypt0</code> structure and encrypt the provided plaintext.  <br /></td></tr>
<tr class="separator:a8d211229ffe582a97d1a003ea67b6511"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a6bf949c01fa888c383ed85bb086cdd85" id="r_a6bf949c01fa888c383ed85bb086cdd85"><td class="memItemLeft" align="right" valign="top"><a id="a6bf949c01fa888c383ed85bb086cdd85" name="a6bf949c01fa888c383ed85bb086cdd85"></a>
static void&#160;</td><td class="memItemRight" valign="bottom"><b>t_cose_encrypt_enc_init</b> (struct <a class="el" href="structt__cose__encrypt__enc.html">t_cose_encrypt_enc</a> *context, uint32_t option_flags, int32_t payload_cose_algorithm_id)</td></tr>
<tr class="separator:a6bf949c01fa888c383ed85bb086cdd85"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table>
<a name="details" id="details"></a><h2 class="groupheader">Detailed Description</h2>
<div class="textblock"><p>Encrypt plaintext and encode it in a CBOR-based structure referred to as COSE_Encrypt0 or COSE_Encrypt. </p>
<p>Warning: documentation may be incorrect in some places here.</p>
<p>The functions defined encrypt plaintext with a symmetric cryptographic algorithm. The result is then stored in <code>COSE_Encrypt0</code> or in a <code>COSE_Encrypt</code> message, as defined in [COSE (RFC 8152)] (<a href="https://tools.ietf.org/html/rfc8152">https://tools.ietf.org/html/rfc8152</a>). <code>COSE_Encrypt0</code> and <code>COSE_Encrypt</code> messages are CBOR encoded binary payloads that contain header parameters, a payload - the ciphertext. The payload may be detached in which case it is not included in the CBOR encoded message and needs to be conveyed separately.</p>
<p><code>COSE_Encrypt</code> and <code>COSE_Encrypt0</code> messages require a symmetric key for encryption (referred to as Content Encryption Key or CEK). Hence, it is necessary to think about key distribution and COSE (RFC 8152) defines various "Content Key Distribution Methods", as RFC 8152 calls it, and two of them are implemented in this library:</p>
<p>1) The CEK is pre-negotiated between the involved communication parties. Hence, no CEK is transported in the COSE message. For this approach the COSE_Encrypt0 message is used.</p>
<p>2) Key agreement: This approach requires utilizes an algorithm for establishing a shared secret, which then serves as a CEK. Therefore, a recipient structure must be included in the COSE message and the COSE_Encrypt message carries such a recipient structure(while <code>COSE_Encrypt0</code> does not). The key agreement algorithm used in this implementation is based on Hybrid Public Key Encryption (HPKE) and is described in <a href="https://datatracker.ietf.org/doc/draft-ietf-cose-hpke/">https://datatracker.ietf.org/doc/draft-ietf-cose-hpke/</a>.</p>
<p>This implementation is intended to be small and portable to different OS's and platforms. Its dependencies are:</p><ul>
<li><a href="https://github.com/laurencelundblade/QCBOR">QCBOR</a></li>
<li>&lt;stdint.h&gt;, &lt;string.h&gt;, &lt;stddef.h&gt;</li>
<li>Encryption functions like AES-GCM.</li>
<li>Hash functions like SHA-256 (for use with HPKE)</li>
</ul>
<p>Additionally, it is necessary to either sign or MAC the resulting COSE_Encrypt0 or COSE_Encrypt message to provide authentication and integrity protection. This functionality is supported by other APIs in the t_cose library.</p>
<p>There is a cryptographic adaptation layer defined in t_cose_crypto.h. An implementation can be made of the functions in it for different cryptographic libraries. This means that different integrations with different cryptographic libraries may, for example, support only encryption with a particular set of algorithms. At this moment, only the integration with Mbed TLS (and more specifically the PSA Crypto API) is supported.</p>
<p>See <a class="el" href="t__cose__common_8h.html" title="This file contains definitions common to all public t_cose interfaces.">t_cose_common.h</a> for preprocessor defines to reduce object code and stack use by disabling features.</p>
<p>Direct key distribution requires the following steps to be taken:</p>
<ol type="1">
<li>Use t_cose_encrypt_enc0_init() to initialize the <code>t_cose_encrypt_enc_ctx</code> context.</li>
<li>Set the CEK with t_cose_encrypt_set_encryption_key().</li>
<li>Call <a class="el" href="t__cose__encrypt__enc_8h.html#a8d211229ffe582a97d1a003ea67b6511" title="Create a COSE_Encrypt or COSE_Encrypt0 structure and encrypt the provided plaintext.">t_cose_encrypt_enc_detached()</a> or <a class="el" href="structt__cose__encrypt__enc.html">t_cose_encrypt_enc()</a>. The former API call does not include the ciphertext in the COSE_Encrypt0 message while the latter API call does.</li>
<li>Call t_cose_encrypt_enc_finish() to create the final output. When subsequently calling QCBOREncode_Finish() the output can be serialized into a byte string for distribution in an Internet protocol.</li>
</ol>
<p>HPKE-based key distribution requires more steps, namely:</p>
<ol type="1">
<li>A recipient context has to be created with t_cose_encrypt_recipient_init().</li>
<li>A CEK has to be generated, for example via the psa_generate_random() API call, and then set via t_cose_encrypt_set_encryption_key().</li>
<li>An ephemeral ECDHE key pair has to be generated, for example via psa_generate_key(), and then assigned to the recipient context using t_cose_encrypt_set_ephemeral_key().</li>
<li>The public key of the recipient has to be imported and assigned to the recipient context via t_cose_encrypt_set_recipient_key().</li>
<li>Now, the recipient structure can be created with t_cose_encrypt_create_recipient(). Using QCBOREncode_Finish() the recipient structure is seralized as a byte string.</li>
<li>Now an encrypt context is needed, which must be initialized with t_cose_encrypt_enc_init().</li>
<li>The t_cose_encrypt_set_encryption_key() is used to configure the CEK with the encryption context, which will subsequently be used to encrypt the plaintext.</li>
<li>The <a class="el" href="t__cose__encrypt__enc_8h.html#a8d211229ffe582a97d1a003ea67b6511" title="Create a COSE_Encrypt or COSE_Encrypt0 structure and encrypt the provided plaintext.">t_cose_encrypt_enc_detached()</a> or the <a class="el" href="structt__cose__encrypt__enc.html">t_cose_encrypt_enc()</a> functions will be used to encrypted the plaintext. 9 The <a class="el" href="t__cose__encrypt__enc_8h.html#a77c7e6f3c82d76704e6f879a05ae786e" title="Add a recipient to an existing COSE encrypt context. Information about a recipient needs to be provid...">t_cose_encrypt_add_recipient()</a> finalizes the COSE_Encrypt message the recipient structure has to be attached. 10.t_cose_encrypt_enc_finish() completes the process and QCBOREncode_Finish() exports the COSE structure as a binary string for use in Internet protocols.</li>
</ol>
<p>In a nutshell, the steps are:</p>
<p>(a) create a recipient structure, which contains the HPKE parameters, (b) create a encrypt structure and encrypt the plaintext, (c) attach the recipient to the encrypt structure, and (d) wrap the entire encrypt structure (which includes the recipient structure). </p>
</div><h2 class="groupheader">Function Documentation</h2>
<a id="a77c7e6f3c82d76704e6f879a05ae786e" name="a77c7e6f3c82d76704e6f879a05ae786e"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a77c7e6f3c82d76704e6f879a05ae786e">&#9670;&#160;</a></span>t_cose_encrypt_add_recipient()</h2>

<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">static void t_cose_encrypt_add_recipient </td>
          <td>(</td>
          <td class="paramtype">struct <a class="el" href="structt__cose__encrypt__enc.html">t_cose_encrypt_enc</a> *&#160;</td>
          <td class="paramname"><em>context</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">struct <a class="el" href="structt__cose__recipient__enc.html">t_cose_recipient_enc</a> *&#160;</td>
          <td class="paramname"><em>recipient</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">inline</span><span class="mlabel">static</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p>Add a recipient to an existing COSE encrypt context. Information about a recipient needs to be provided. </p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramdir">[in]</td><td class="paramname">context</td><td>The t_cose_encrypt_enc_ctx context. </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">recipient</td><td>Pointer to recipient object.</td></tr>
  </table>
  </dd>
</dl>
<p>The recipient object should be initialized with algorithm ID and key material. Note that for COSE encryption there are two algorithm IDs, the one for the payload/content set with <a class="el" href="t__cose__encrypt__enc_8h.html#ae270e09acdbb973b45588bb52f546cf5" title="Initialize to start creating a COSE_Encrypt structure.">t_cose_encypt_enc_init()</a> and the one for COSE_Recpient set in the API implementing it.</p>
<p>The recipient object set here has callbacks that will when <a class="el" href="structt__cose__encrypt__enc.html">t_cose_encrypt_enc()</a> is doing its work.</p>
<p>For multiple recipients this is called multiple times. For direct encryption this is not called. </p>

</div>
</div>
<a id="a337c5145eeb638b5bb78ed592d6d5ea8" name="a337c5145eeb638b5bb78ed592d6d5ea8"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a337c5145eeb638b5bb78ed592d6d5ea8">&#9670;&#160;</a></span>t_cose_encrypt_enc()</h2>

<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">static enum <a class="el" href="t__cose__common_8h.html#a469580b586841b779bbdc430d3a0dd97">t_cose_err_t</a> <a class="el" href="structt__cose__encrypt__enc.html">t_cose_encrypt_enc</a> </td>
          <td>(</td>
          <td class="paramtype">struct <a class="el" href="structt__cose__encrypt__enc.html">t_cose_encrypt_enc</a> *&#160;</td>
          <td class="paramname"><em>context</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">struct q_useful_buf_c&#160;</td>
          <td class="paramname"><em>payload</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">struct q_useful_buf_c&#160;</td>
          <td class="paramname"><em>ext_sup_data</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">struct q_useful_buf&#160;</td>
          <td class="paramname"><em>buffer_for_message</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">struct q_useful_buf_c *&#160;</td>
          <td class="paramname"><em>encrypted_message</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">inline</span><span class="mlabel">static</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p>Create a <code>COSE_Encrypt</code> or <code>COSE_Encrypt0</code> structure and encrypt the provided plaintext. </p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramdir">[in]</td><td class="paramname">context</td><td>The t_cose_encrypt_enc_ctx context. </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">payload</td><td>Plaintext to be encypted. </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">ext_sup_data</td><td>External supplied data or NULL_Q_USEFUL_BUF. </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">buffer_for_message</td><td>Buffer for COSE message. </td></tr>
    <tr><td class="paramdir">[out]</td><td class="paramname">encrypted_message</td><td>Completed COSE message.</td></tr>
  </table>
  </dd>
</dl>
<dl class="section return"><dt>Returns</dt><dd>This returns one of the error codes defined by <a class="el" href="t__cose__common_8h.html#a469580b586841b779bbdc430d3a0dd97">t_cose_err_t</a>.</dd></dl>
<p>This is where all the work gets done including calling the cryptographic algorithms. In most cases this will cause callbacks to the <a class="el" href="structt__cose__recipient__enc.html">t_cose_recipient_enc</a> object to be made to create the COSE_Recipients. Only when direct encryption is used are they not called.</p>
<p><code>ext_sup_data</code> is additional data to be integrity protected by the AEAD algorthim. This the data described in section 4.3 of RFC 9052. Note that this data (nor the payload) is authenticated in the same way it is when signed. TODO: sort out what happens with no AEAD TODO: describe this all better.</p>
<p>The size of encoded protected parameters plus the externally supplied data is limited to TODO by default. If it is exceeded the error TODO: will be returned. See TODO to increase this.</p>
<p>This puts the encrypted payload in the body of the message. See also <a class="el" href="t__cose__encrypt__enc_8h.html#a8d211229ffe582a97d1a003ea67b6511" title="Create a COSE_Encrypt or COSE_Encrypt0 structure and encrypt the provided plaintext.">t_cose_encrypt_enc_detached()</a>.</p>
<p><code>buffer_for_message</code> must be large enough to hold the resulting COSE_Encrypt or COSE_Encrypt0 message with the encrypted payload in the message. To use this in size calculation mode, pass a <code>buffer_for_message</code> with ptr NULL and a very large size like <code>SIZE_MAX</code>. </p>

</div>
</div>
<a id="a71f21663f9a86bf74530ad019bb7865f" name="a71f21663f9a86bf74530ad019bb7865f"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a71f21663f9a86bf74530ad019bb7865f">&#9670;&#160;</a></span>t_cose_encrypt_enc_body_header_params()</h2>

<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">static void t_cose_encrypt_enc_body_header_params </td>
          <td>(</td>
          <td class="paramtype">struct <a class="el" href="structt__cose__encrypt__enc.html">t_cose_encrypt_enc</a> *&#160;</td>
          <td class="paramname"><em>context</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">struct <a class="el" href="structt__cose__parameter.html">t_cose_parameter</a> *&#160;</td>
          <td class="paramname"><em>parameters</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">inline</span><span class="mlabel">static</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p>Add header parameters to the <code>COSE_Encrypt0</code> or <code>COSE_Encrypt</code> main body. </p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramdir">[in]</td><td class="paramname">context</td><td>The t_cose encrypting context. </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">parameters</td><td>Linkes list of parameters to add.</td></tr>
  </table>
  </dd>
</dl>
<p>For simple use cases it is not necessary to call this as the algorithm ID, the only mandatory parameter, is automatically added.</p>
<p>This adds parameters to the <code>COSE_Encrypt0</code> <code>COSE_Encrypt</code> body. Parameters in <code>COSE_Recipient</code> in <code>COSE_Encrypt</code> are handed through <a class="el" href="structt__cose__recipient__enc.html">t_cose_recipient_enc</a>.</p>
<p>This adds a linked list of struct <a class="el" href="structt__cose__parameter.html">t_cose_parameter</a> terminated by a NULL.</p>
<p>Parameters with integer and string parameters are handled by putting there values in the struct <a class="el" href="structt__cose__parameter.html">t_cose_parameter</a> node in the linked list..</p>
<p>All the parameters must have a label and a value.</p>
<p>Alternatively, and particularly for parameters that are not integers or strings the value may be a callback of type t_cose_parameter_encode_callback in which case the callback will be called when it is time to output the CBOR for the custom header. The callback should output the CBOR for the particular parameter.</p>
<p>This supports only integer labels. (String labels could be added but would increase object code size).</p>
<p>All parameters must be added in one call. Multiple calls to this don't accumlate parameters. </p>

</div>
</div>
<a id="a8d211229ffe582a97d1a003ea67b6511" name="a8d211229ffe582a97d1a003ea67b6511"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a8d211229ffe582a97d1a003ea67b6511">&#9670;&#160;</a></span>t_cose_encrypt_enc_detached()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">enum <a class="el" href="t__cose__common_8h.html#a469580b586841b779bbdc430d3a0dd97">t_cose_err_t</a> t_cose_encrypt_enc_detached </td>
          <td>(</td>
          <td class="paramtype">struct <a class="el" href="structt__cose__encrypt__enc.html">t_cose_encrypt_enc</a> *&#160;</td>
          <td class="paramname"><em>context</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">struct q_useful_buf_c&#160;</td>
          <td class="paramname"><em>payload</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">struct q_useful_buf_c&#160;</td>
          <td class="paramname"><em>ext_sup_data</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">struct q_useful_buf&#160;</td>
          <td class="paramname"><em>buffer_for_detached</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">struct q_useful_buf&#160;</td>
          <td class="paramname"><em>buffer_for_message</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">struct q_useful_buf_c *&#160;</td>
          <td class="paramname"><em>encrypted_detached</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">struct q_useful_buf_c *&#160;</td>
          <td class="paramname"><em>encrypted_message</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Create a <code>COSE_Encrypt</code> or <code>COSE_Encrypt0</code> structure and encrypt the provided plaintext. </p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramdir">[in]</td><td class="paramname">context</td><td>The t_cose_encrypt_enc_ctx context. </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">payload</td><td>Plaintext to be encypted. </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">ext_sup_data</td><td>External supplimentary data or NULL_Q_USEFUL_BUF. </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">buffer_for_detached</td><td>Buffer for detached cipher text. </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">buffer_for_message</td><td>Buffer for COSE message. </td></tr>
    <tr><td class="paramdir">[out]</td><td class="paramname">encrypted_detached</td><td>Detached ciphertext. </td></tr>
    <tr><td class="paramdir">[out]</td><td class="paramname">encrypted_message</td><td>Completed COSE message.</td></tr>
  </table>
  </dd>
</dl>
<dl class="section return"><dt>Returns</dt><dd>This returns one of the error codes defined by <a class="el" href="t__cose__common_8h.html#a469580b586841b779bbdc430d3a0dd97">t_cose_err_t</a>.</dd></dl>
<p>This is the same as <a class="el" href="structt__cose__encrypt__enc.html">t_cose_encrypt_enc()</a> except it produces two separate outputs, the detached ciphertext and the <code>COSE_Encrypt</code> or <code>COSE_Encrypt0</code>. Typically the detached ciphertext is 16 bytes larger than then payload and the COSE_Encrypt COSE_Encrypt is relatively small and fixed.</p>
<p>This may be used in size calculation mode in which case both the size of the detached ciphertext and the encrypted message will be computed and returned.</p>
<p><code>buffer_for_detached</code> may be NULL_Q_USEFUL_BUF and <code>encrypted_detached</code> may be <code>NULL</code> in which case this behaves exactly like <a class="el" href="structt__cose__encrypt__enc.html">t_cose_encrypt_enc()</a>. </p>

</div>
</div>
<a id="ae603f38c0f103d2c7be2a6d2316bd100" name="ae603f38c0f103d2c7be2a6d2316bd100"></a>
<h2 class="memtitle"><span class="permalink"><a href="#ae603f38c0f103d2c7be2a6d2316bd100">&#9670;&#160;</a></span>t_cose_encrypt_set_cek()</h2>

<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">static void t_cose_encrypt_set_cek </td>
          <td>(</td>
          <td class="paramtype">struct <a class="el" href="structt__cose__encrypt__enc.html">t_cose_encrypt_enc</a> *&#160;</td>
          <td class="paramname"><em>context</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">struct <a class="el" href="structt__cose__key.html">t_cose_key</a>&#160;</td>
          <td class="paramname"><em>cek</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">inline</span><span class="mlabel">static</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p>Set the content-encryption key, the CEK. </p>
<p>This is required for COSE_Encrypt0 when there is no recipient. This may be used for COSE_Encrypt to explicitly set the CEK. If it is not called the CEK will automatically be generated using the random number generator. (Which random number generator depends on the crypto adaptor layer, but is usually the highest-quality generator on the device. Typically the port of OpenSSL or MbedTLS to the particular platform will use the highest-quality generator).</p>
<p>RFC 9052 section 5.2 discourages setting the kid for COSE_Encrypt0 so this API doesn't faciliate it, but <a class="el" href="t__cose__encrypt__enc_8h.html#a71f21663f9a86bf74530ad019bb7865f" title="Add header parameters to the COSE_Encrypt0 or COSE_Encrypt main body.">t_cose_encrypt_enc_body_header_params()</a> can be used to set it.</p>
<p>RFC 9052 uses the term "direct" encryption sometimes to refer to COSE_Encrypt0, but much more prevalentaly uses it to refer to a type of COSE_Recipient. See the t_cose_recipient_direct (which hasn't been created yet) </p>

</div>
</div>
<a id="a255aced5336f699201e8ed7db57e6803" name="a255aced5336f699201e8ed7db57e6803"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a255aced5336f699201e8ed7db57e6803">&#9670;&#160;</a></span>t_cose_encrypt_set_enc_struct_buffer()</h2>

<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">static void t_cose_encrypt_set_enc_struct_buffer </td>
          <td>(</td>
          <td class="paramtype">struct <a class="el" href="structt__cose__encrypt__enc.html">t_cose_encrypt_enc</a> *&#160;</td>
          <td class="paramname"><em>context</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">struct q_useful_buf&#160;</td>
          <td class="paramname"><em>enc_buffer</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">inline</span><span class="mlabel">static</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p>Setup buffer for larger externally supplied data or header parameters. </p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramdir">[in]</td><td class="paramname">context</td><td>The encryption context </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">enc_buffer</td><td>Pointer and length of buffer to add.</td></tr>
  </table>
  </dd>
</dl>
<p>By default there is a limit of T_COSE_ENCRYPT_STRUCT_DEFAULT_SIZE (typically 64 bytes) for the externally supplied data and protected header parameters. Normally this is quite adequate, but it may not be in all cases. If not call this with a larger buffer.</p>
<p>Specifically, this is the buffer to create the Enc_structure described in RFC 9052 section 5.2. It needs to be the size of the CBOR-encoded protected headers, the externally supplied data and some overhead.</p>
<p>TODO: size calculation mode that will tell the caller how big it should be </p>

</div>
</div>
<a id="ae270e09acdbb973b45588bb52f546cf5" name="ae270e09acdbb973b45588bb52f546cf5"></a>
<h2 class="memtitle"><span class="permalink"><a href="#ae270e09acdbb973b45588bb52f546cf5">&#9670;&#160;</a></span>t_cose_encypt_enc_init()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void t_cose_encypt_enc_init </td>
          <td>(</td>
          <td class="paramtype">struct <a class="el" href="structt__cose__encrypt__enc.html">t_cose_encrypt_enc</a> *&#160;</td>
          <td class="paramname"><em>context</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">uint32_t&#160;</td>
          <td class="paramname"><em>option_flags</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int32_t&#160;</td>
          <td class="paramname"><em>payload_cose_algorithm_id</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Initialize to start creating a <code>COSE_Encrypt</code> structure. </p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramdir">[in,out]</td><td class="paramname">context</td><td>The t_cose_encrypt_enc_ctx context. </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">option_flags</td><td>One of <code>T_COSE_OPT_XXXX</code>. </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">payload_cose_algorithm_id</td><td>The algorithm to use for encrypting data, for example COSE_ALGORITHM_A128GCM.</td></tr>
  </table>
  </dd>
</dl>
<p>The lower bits of option_flags may be either T_COSE_OPT_MESSAGE_TYPE_ENCRYPT0 or T_COSE_OPT_MESSAGE_TYPE_ENCRYPT to select the message type. If the lower bits are zero it will default to \re T_COSE_OPT_MESSAGE_TYPE_ENCRYPT0.</p>
<p>The algorithm ID is requires and is from <a href="https://tools.ietf.org/html/rfc9053">COSE (RFC9053)</a> and the <a href="https://www.iana.org/assignments/cose/cose.xhtml">IANA COSE Registry</a>. T_COSE_ALGORITHM_A128GCM and a few others are defined here for convenience. The supported algorithms depend on the cryptographic library that t_cose is integrated with. The algorithm ID given here is for the bulk encryption of the payload, typically an AES AEAD algorithm. (Non-recpient HPKE will be an exception here.)</p>
<p>The algorithm ID for the COSE_Recipient is set in the particular <a class="el" href="structt__cose__recipient__enc.html">t_cose_recipient_enc</a> being used. You can even have serveral with different algorithms (but there can only be one payload encryption algorithm). </p>

</div>
</div>
</div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by&#160;<a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.8
</small></address>
</body>
</html>
