<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.9.8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>t_cose: inc/t_cose/t_cose_encrypt_dec.h File Reference</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectalign">
   <div id="projectname">t_cose
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.8 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search/",'.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

<div id="nav-path" class="navpath">
  <ul>
<li class="navelem"><a class="el" href="dir_bfccd401955b95cf8c75461437045ac0.html">inc</a></li><li class="navelem"><a class="el" href="dir_c790dd4d93afe6413732f56f53ec2af4.html">t_cose</a></li>  </ul>
</div>
</div><!-- top -->
<div class="header">
  <div class="summary">
<a href="#nested-classes">Data Structures</a> &#124;
<a href="#func-members">Functions</a>  </div>
  <div class="headertitle"><div class="title">t_cose_encrypt_dec.h File Reference</div></div>
</div><!--header-->
<div class="contents">

<p>Process a COSE_Encrypt0 or COSE_Encrypt message, which decrypts the integrated or detached ciphertext.  
<a href="#details">More...</a></p>
<div class="textblock"><code>#include &lt;stdint.h&gt;</code><br />
<code>#include &lt;stdlib.h&gt;</code><br />
<code>#include &quot;<a class="el" href="t__cose__parameters_8h_source.html">t_cose_parameters.h</a>&quot;</code><br />
<code>#include &quot;t_cose/t_cose_recipient_dec.h&quot;</code><br />
<code>#include &quot;<a class="el" href="t__cose__key_8h_source.html">t_cose/t_cose_key.h</a>&quot;</code><br />
</div>
<p><a href="t__cose__encrypt__dec_8h_source.html">Go to the source code of this file.</a></p>
<table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a id="nested-classes" name="nested-classes"></a>
Data Structures</h2></td></tr>
<tr class="memitem:"><td class="memItemLeft" align="right" valign="top">struct &#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="structt__cose__encrypt__dec__ctx.html">t_cose_encrypt_dec_ctx</a></td></tr>
<tr class="separator:"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table><table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a id="func-members" name="func-members"></a>
Functions</h2></td></tr>
<tr class="memitem:abb500c8d070af077f88486d441c15958" id="r_abb500c8d070af077f88486d441c15958"><td class="memItemLeft" align="right" valign="top">static void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="t__cose__encrypt__dec_8h.html#abb500c8d070af077f88486d441c15958">t_cose_encrypt_dec_init</a> (struct <a class="el" href="structt__cose__encrypt__dec__ctx.html">t_cose_encrypt_dec_ctx</a> *context, uint32_t option_flags)</td></tr>
<tr class="memdesc:abb500c8d070af077f88486d441c15958"><td class="mdescLeft">&#160;</td><td class="mdescRight">Initialize context to decrypt a <code>COSE_Encrypt</code> or <code>COSE_Encrypt0</code>.  <br /></td></tr>
<tr class="separator:abb500c8d070af077f88486d441c15958"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:afc801f8f66722926c37407cfc7cdae53" id="r_afc801f8f66722926c37407cfc7cdae53"><td class="memItemLeft" align="right" valign="top">static void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="t__cose__encrypt__dec_8h.html#afc801f8f66722926c37407cfc7cdae53">t_cose_encrypt_dec_set_cek</a> (struct <a class="el" href="structt__cose__encrypt__dec__ctx.html">t_cose_encrypt_dec_ctx</a> *context, struct <a class="el" href="structt__cose__key.html">t_cose_key</a> cek)</td></tr>
<tr class="memdesc:afc801f8f66722926c37407cfc7cdae53"><td class="mdescLeft">&#160;</td><td class="mdescRight">Set content encryption key for <code>COSE_Encrypt0</code>.  <br /></td></tr>
<tr class="separator:afc801f8f66722926c37407cfc7cdae53"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a571743f82fa29e9b687967e7d3195f4b" id="r_a571743f82fa29e9b687967e7d3195f4b"><td class="memItemLeft" align="right" valign="top">static void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="t__cose__encrypt__dec_8h.html#a571743f82fa29e9b687967e7d3195f4b">t_cose_encrypt_dec_add_recipient</a> (struct <a class="el" href="structt__cose__encrypt__dec__ctx.html">t_cose_encrypt_dec_ctx</a> *context, struct <a class="el" href="structt__cose__recipient__dec.html">t_cose_recipient_dec</a> *recipient)</td></tr>
<tr class="memdesc:a571743f82fa29e9b687967e7d3195f4b"><td class="mdescLeft">&#160;</td><td class="mdescRight">Add a <code>COSE_Recipient</code> decryptor/decoder.  <br /></td></tr>
<tr class="separator:a571743f82fa29e9b687967e7d3195f4b"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a0f973e5d836467553d731be212e42ece" id="r_a0f973e5d836467553d731be212e42ece"><td class="memItemLeft" align="right" valign="top">static void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="t__cose__encrypt__dec_8h.html#a0f973e5d836467553d731be212e42ece">t_cose_encrypt_add_param_storage</a> (struct <a class="el" href="structt__cose__encrypt__dec__ctx.html">t_cose_encrypt_dec_ctx</a> *context, struct <a class="el" href="structt__cose__parameter__storage.html">t_cose_parameter_storage</a> *storage)</td></tr>
<tr class="memdesc:a0f973e5d836467553d731be212e42ece"><td class="mdescLeft">&#160;</td><td class="mdescRight">Add storage for header parameter decoding.  <br /></td></tr>
<tr class="separator:a0f973e5d836467553d731be212e42ece"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a65c94457015b3f1f9eaa36982679ae02" id="r_a65c94457015b3f1f9eaa36982679ae02"><td class="memItemLeft" align="right" valign="top">static void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="t__cose__encrypt__dec_8h.html#a65c94457015b3f1f9eaa36982679ae02">t_cose_decrypt_set_enc_struct_buffer</a> (struct <a class="el" href="structt__cose__encrypt__dec__ctx.html">t_cose_encrypt_dec_ctx</a> *context, struct q_useful_buf enc_buffer)</td></tr>
<tr class="memdesc:a65c94457015b3f1f9eaa36982679ae02"><td class="mdescLeft">&#160;</td><td class="mdescRight">Setup buffer for larger externally supplied data or header parameters.  <br /></td></tr>
<tr class="separator:a65c94457015b3f1f9eaa36982679ae02"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:ab3198cda334bf2ca09dc28318578a4d9" id="r_ab3198cda334bf2ca09dc28318578a4d9"><td class="memItemLeft" align="right" valign="top">static enum <a class="el" href="t__cose__common_8h.html#a469580b586841b779bbdc430d3a0dd97">t_cose_err_t</a>&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="t__cose__encrypt__dec_8h.html#ab3198cda334bf2ca09dc28318578a4d9">t_cose_encrypt_dec</a> (struct <a class="el" href="structt__cose__encrypt__dec__ctx.html">t_cose_encrypt_dec_ctx</a> *context, QCBORDecodeContext *cbor_decoder, struct q_useful_buf_c ext_sup_data, struct q_useful_buf plaintext_buffer, struct q_useful_buf_c *plaintext, struct <a class="el" href="structt__cose__parameter.html">t_cose_parameter</a> **returned_parameters)</td></tr>
<tr class="memdesc:ab3198cda334bf2ca09dc28318578a4d9"><td class="mdescLeft">&#160;</td><td class="mdescRight">Decryption of a <code>COSE_Encrypt0</code> or <code>COSE_Encrypt</code> structure.  <br /></td></tr>
<tr class="separator:ab3198cda334bf2ca09dc28318578a4d9"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a55df1131285e920487980a0075367d24" id="r_a55df1131285e920487980a0075367d24"><td class="memItemLeft" align="right" valign="top">static enum <a class="el" href="t__cose__common_8h.html#a469580b586841b779bbdc430d3a0dd97">t_cose_err_t</a>&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="t__cose__encrypt__dec_8h.html#a55df1131285e920487980a0075367d24">t_cose_encrypt_dec_detached</a> (struct <a class="el" href="structt__cose__encrypt__dec__ctx.html">t_cose_encrypt_dec_ctx</a> *context, QCBORDecodeContext *cbor_decoder, struct q_useful_buf_c ext_sup_data, struct q_useful_buf_c detached_ciphertext, struct q_useful_buf plaintext_buffer, struct q_useful_buf_c *plaintext, struct <a class="el" href="structt__cose__parameter.html">t_cose_parameter</a> **returned_parameters)</td></tr>
<tr class="memdesc:a55df1131285e920487980a0075367d24"><td class="mdescLeft">&#160;</td><td class="mdescRight">Decrypt a <code>COSE_Encrypt0</code> or <code>COSE_Encrypt</code> with detached cipher text.  <br /></td></tr>
<tr class="separator:a55df1131285e920487980a0075367d24"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a73cd562b01edd9aea6e592cc2fa4ff77" id="r_a73cd562b01edd9aea6e592cc2fa4ff77"><td class="memItemLeft" align="right" valign="top"><a id="a73cd562b01edd9aea6e592cc2fa4ff77" name="a73cd562b01edd9aea6e592cc2fa4ff77"></a>
enum <a class="el" href="t__cose__common_8h.html#a469580b586841b779bbdc430d3a0dd97">t_cose_err_t</a>&#160;</td><td class="memItemRight" valign="bottom"><b>t_cose_encrypt_dec_msg</b> (struct <a class="el" href="structt__cose__encrypt__dec__ctx.html">t_cose_encrypt_dec_ctx</a> *context, struct q_useful_buf_c cose_message, struct q_useful_buf_c ext_sup_data, struct q_useful_buf plaintext_buffer, struct q_useful_buf_c *plaintext, struct <a class="el" href="structt__cose__parameter.html">t_cose_parameter</a> **returned_parameters, uint64_t tag_numbers[<a class="el" href="t__cose__common_8h.html#a7a0e083f1728e5e46fc28d913e771b4a">T_COSE_MAX_TAGS_TO_RETURN</a>])</td></tr>
<tr class="separator:a73cd562b01edd9aea6e592cc2fa4ff77"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:af56799301a9de19d69b7eccff212e1bf" id="r_af56799301a9de19d69b7eccff212e1bf"><td class="memItemLeft" align="right" valign="top"><a id="af56799301a9de19d69b7eccff212e1bf" name="af56799301a9de19d69b7eccff212e1bf"></a>
enum <a class="el" href="t__cose__common_8h.html#a469580b586841b779bbdc430d3a0dd97">t_cose_err_t</a>&#160;</td><td class="memItemRight" valign="bottom"><b>t_cose_encrypt_dec_detached_msg</b> (struct <a class="el" href="structt__cose__encrypt__dec__ctx.html">t_cose_encrypt_dec_ctx</a> *context, struct q_useful_buf_c cose_message, struct q_useful_buf_c ext_sup_data, struct q_useful_buf_c detached_ciphertext, struct q_useful_buf plaintext_buffer, struct q_useful_buf_c *plaintext, struct <a class="el" href="structt__cose__parameter.html">t_cose_parameter</a> **returned_parameters, uint64_t tag_numbers[<a class="el" href="t__cose__common_8h.html#a7a0e083f1728e5e46fc28d913e771b4a">T_COSE_MAX_TAGS_TO_RETURN</a>])</td></tr>
<tr class="separator:af56799301a9de19d69b7eccff212e1bf"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:ac9e01ee9b6cf2d40565c972793478b7e" id="r_ac9e01ee9b6cf2d40565c972793478b7e"><td class="memItemLeft" align="right" valign="top"><a id="ac9e01ee9b6cf2d40565c972793478b7e" name="ac9e01ee9b6cf2d40565c972793478b7e"></a>
enum <a class="el" href="t__cose__common_8h.html#a469580b586841b779bbdc430d3a0dd97">t_cose_err_t</a>&#160;</td><td class="memItemRight" valign="bottom"><b>t_cose_encrypt_dec_main_private</b> (struct <a class="el" href="structt__cose__encrypt__dec__ctx.html">t_cose_encrypt_dec_ctx</a> *me, QCBORDecodeContext *cbor_decoder, const struct q_useful_buf_c ext_sup_data, const struct q_useful_buf_c detached_ciphertext, struct q_useful_buf plaintext_buffer, struct q_useful_buf_c *plaintext, struct <a class="el" href="structt__cose__parameter.html">t_cose_parameter</a> **returned_parameters, uint64_t tag_numbers[<a class="el" href="t__cose__common_8h.html#a7a0e083f1728e5e46fc28d913e771b4a">T_COSE_MAX_TAGS_TO_RETURN</a>])</td></tr>
<tr class="separator:ac9e01ee9b6cf2d40565c972793478b7e"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table>
<a name="details" id="details"></a><h2 class="groupheader">Detailed Description</h2>
<div class="textblock"><p>Process a COSE_Encrypt0 or COSE_Encrypt message, which decrypts the integrated or detached ciphertext. </p>
<p>The functions in this file decrypt ciphertext with a symmetric cryptographic algorithm, as defined in [COSE (RFC 9052)] (<a href="https://tools.ietf.org/html/rfc9052">https://tools.ietf.org/html/rfc9052</a>), for use with <code>COSE_Encrypt0</code> and <code>COSE_Encrypt</code> messages. The ciphertext may be detached, in which case it is not included in the CBOR encoded message.</p>
<p><code>COSE_Encrypt</code> and <code>COSE_Encrypt0</code> messages require a symmetric key for decryption (referred to as Content Encryption Key or CEK). For <code>COSE_Encrypt0</code> the CEK is supplied directly by an API below. For <code>COSE_Encrypt</code> the CEK is provided in a <code>COSE_Recipient</code> that is carried in the <code>COSE_Encrypt</code>. There several types of <code>COSE_Recipient</code> such as HPKE and keywrap. <code>COSE_Recipient</code> implementations are separate objects that plug-in here. This supports multiple <code>COSE_Recipients</code> and <code>COSE_Recipients</code> of multiple types simultanesously. They are defined in separate headers files.</p>
<p>This implementation is intended to be small and portable to different OS's and platforms. Its dependencies are:</p><ul>
<li><a href="https://github.com/laurencelundblade/QCBOR">QCBOR</a></li>
<li>&lt;stdint.h&gt;, &lt;string.h&gt;, &lt;stddef.h&gt;</li>
<li>Decryption functions like AES-GCM.</li>
<li>HPKE when COSE_Encrypt is utilized. The HPKE library can be found at <a href="https://github.com/hannestschofenig/mbedtls/tree/hpke">https://github.com/hannestschofenig/mbedtls/tree/hpke</a></li>
<li>Hash functions like SHA-256 (for use with HPKE)</li>
</ul>
<p>Prior to using the decryption functionality, a digital signature or MAC should be verified. Signing and MACing is supported by other APIs in the t_cose library.</p>
<p>There is a cryptographic adaptation layer defined in t_cose_crypto.h. An implementation can be made of the functions in it for different cryptographic libraries. This means that different integrations with different cryptographic libraries may, for example, support only encryption with a particular set of algorithms. At this moment, only the integration with Mbed TLS (and more specifically the PSA Crypto API) is supported.</p>
<p>See <a class="el" href="t__cose__common_8h.html" title="This file contains definitions common to all public t_cose interfaces.">t_cose_common.h</a> for preprocessor defines to reduce object code and stack use by disabling features. </p>
</div><h2 class="groupheader">Function Documentation</h2>
<a id="a65c94457015b3f1f9eaa36982679ae02" name="a65c94457015b3f1f9eaa36982679ae02"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a65c94457015b3f1f9eaa36982679ae02">&#9670;&#160;</a></span>t_cose_decrypt_set_enc_struct_buffer()</h2>

<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">static void t_cose_decrypt_set_enc_struct_buffer </td>
          <td>(</td>
          <td class="paramtype">struct <a class="el" href="structt__cose__encrypt__dec__ctx.html">t_cose_encrypt_dec_ctx</a> *&#160;</td>
          <td class="paramname"><em>context</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">struct q_useful_buf&#160;</td>
          <td class="paramname"><em>enc_buffer</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">inline</span><span class="mlabel">static</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p>Setup buffer for larger externally supplied data or header parameters. </p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramdir">[in]</td><td class="paramname">context</td><td>The encryption context </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">enc_buffer</td><td>Pointer and length of buffer to add.</td></tr>
  </table>
  </dd>
</dl>
<p>By default there is a limit of T_COSE_ENCRYPT_STRUCT_DEFAULT_SIZE (typically 64 bytes) for the externally supplied data and protected header parameters. Normally this is quite adequate, but it may not be in all cases. If not call this with a larger buffer.</p>
<p>Specifically, this is the buffer to create the Enc_structure described in RFC 9052 section 5.2. It needs to be the size of the CBOR-encoded protected headers, the externally supplied data and some overhead.</p>
<p>TODO: size calculation mode that will tell the caller how big it should be </p>

</div>
</div>
<a id="a0f973e5d836467553d731be212e42ece" name="a0f973e5d836467553d731be212e42ece"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a0f973e5d836467553d731be212e42ece">&#9670;&#160;</a></span>t_cose_encrypt_add_param_storage()</h2>

<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">static void t_cose_encrypt_add_param_storage </td>
          <td>(</td>
          <td class="paramtype">struct <a class="el" href="structt__cose__encrypt__dec__ctx.html">t_cose_encrypt_dec_ctx</a> *&#160;</td>
          <td class="paramname"><em>context</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">struct <a class="el" href="structt__cose__parameter__storage.html">t_cose_parameter_storage</a> *&#160;</td>
          <td class="paramname"><em>storage</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">inline</span><span class="mlabel">static</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p>Add storage for header parameter decoding. </p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramdir">[in]</td><td class="paramname">context</td><td>Encrypted message decryption context. </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">storage</td><td>The parameter storage to add.</td></tr>
  </table>
  </dd>
</dl>
<p>This is optionally called to increase the number of storage nodes for COSE_Encrypt or COSE_Encrypt0 message with T_COSE_NUM_DECODE_HEADERS header parameters. Decoded parameters are returned in a linked list of struct <a class="el" href="structt__cose__parameter.html">t_cose_parameter</a>. The storage for the nodes in the list is not dynamically allocated as there is no dynamic storage allocation used here.</p>
<p>It is assumed that the number of parameters is small and/or can be anticipated. There must be room to decode all the header parameters that are in the body and in all in the COSE_Signatures. If not <a class="el" href="t__cose__common_8h.html#a469580b586841b779bbdc430d3a0dd97aa2a158c2198a24c1d22ba3706ff8182b">T_COSE_ERR_TOO_MANY_PARAMETERS</a> will be returned by t_cose_sign_verify() and similar.</p>
<p>By default, if this is not called there is internal storage for T_COSE_NUM_DECODE_HEADERS headers. If this is not enough call this function to use external storage instead of the internal. This replaces the internal storage. It does not add to it.</p>
<p><a class="el" href="structt__cose__parameter__storage.html">t_cose_parameter_storage</a> allows for the storage to be partially used when it is passed in and whatever is not used by this decode can be used elsewhere. It internall keeps track of how many nodes were used. </p>

</div>
</div>
<a id="ab3198cda334bf2ca09dc28318578a4d9" name="ab3198cda334bf2ca09dc28318578a4d9"></a>
<h2 class="memtitle"><span class="permalink"><a href="#ab3198cda334bf2ca09dc28318578a4d9">&#9670;&#160;</a></span>t_cose_encrypt_dec()</h2>

<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">static enum <a class="el" href="t__cose__common_8h.html#a469580b586841b779bbdc430d3a0dd97">t_cose_err_t</a> t_cose_encrypt_dec </td>
          <td>(</td>
          <td class="paramtype">struct <a class="el" href="structt__cose__encrypt__dec__ctx.html">t_cose_encrypt_dec_ctx</a> *&#160;</td>
          <td class="paramname"><em>context</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">QCBORDecodeContext *&#160;</td>
          <td class="paramname"><em>cbor_decoder</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">struct q_useful_buf_c&#160;</td>
          <td class="paramname"><em>ext_sup_data</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">struct q_useful_buf&#160;</td>
          <td class="paramname"><em>plaintext_buffer</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">struct q_useful_buf_c *&#160;</td>
          <td class="paramname"><em>plaintext</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">struct <a class="el" href="structt__cose__parameter.html">t_cose_parameter</a> **&#160;</td>
          <td class="paramname"><em>returned_parameters</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">inline</span><span class="mlabel">static</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p>Decryption of a <code>COSE_Encrypt0</code> or <code>COSE_Encrypt</code> structure. </p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramdir">[in,out]</td><td class="paramname">context</td><td>The <a class="el" href="structt__cose__encrypt__dec__ctx.html">t_cose_encrypt_dec_ctx</a> context. </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">cbor_decoder</td><td>Source of the input COSE message to decrypt. </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">ext_sup_data</td><td>Externally supplied data or NULL_Q_USEFUL_BUF. </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">plaintext_buffer</td><td>A buffer for plaintext. </td></tr>
    <tr><td class="paramdir">[out]</td><td class="paramname">plaintext</td><td>Place to return pointer and length of the plaintext. </td></tr>
    <tr><td class="paramdir">[out]</td><td class="paramname">returned_parameters</td><td>Linked list of all header parameters.</td></tr>
  </table>
  </dd>
</dl>
<dl class="section return"><dt>Returns</dt><dd>This returns one of the error codes defined by <a class="el" href="t__cose__common_8h.html#a469580b586841b779bbdc430d3a0dd97">t_cose_err_t</a>.</dd></dl>
<p>This returns the decrypted plain text.</p>
<p>It accepts either COSE_Encrypt0 or COSE_Encrypt. For COSE_Encrypt0, <a class="el" href="t__cose__encrypt__dec_8h.html#afc801f8f66722926c37407cfc7cdae53" title="Set content encryption key for COSE_Encrypt0.">t_cose_encrypt_dec_set_cek()</a> must have been called to set the decryption key. For COSE_Encrypt, <a class="el" href="t__cose__encrypt__dec_8h.html#a571743f82fa29e9b687967e7d3195f4b" title="Add a COSE_Recipient decryptor/decoder.">t_cose_encrypt_dec_add_recipient()</a> must have been called to provide COSE_Recipient processers that have been set up with decryption keys.</p>
<p>If <code>context</code> was set up with T_COSE_OPT_MESSAGE_TYPE_UNSPECIFIED, this expects one tag number to indicate COSE_Encrypt vs COSE_Encryptt0. Other wise the context must have been set up to indicate COSE_Encrypt or COSE_Encrypt0 and no tag numbers are expected. That is, the caller should have consumed any tag numbers before calling this. See t_cose_encrypt_dec_message() which does more tag number processing.</p>
<p>Each struct <a class="el" href="structt__cose__recipient__dec.html">t_cose_recipient_dec</a> is invoked on each <code>COSE_Recipient</code> until one successfully decrypts the content encryption key. Only one success is necessary. Each <a class="el" href="structt__cose__recipient__dec.html">t_cose_recipient_dec</a> may decline to decrypt if it is not suitable for the particular COSE_Recipient (the algorith ID doesn't match) or if the key ID (the kid) doesn't match). If a <a class="el" href="structt__cose__recipient__dec.html">t_cose_recipient_dec</a> attempts and fails, this is a hard error that stops the decode of the whole COSE_Encrypt.</p>
<p>See also <a class="el" href="t__cose__encrypt__dec_8h.html#a55df1131285e920487980a0075367d24" title="Decrypt a COSE_Encrypt0 or COSE_Encrypt with detached cipher text.">t_cose_encrypt_dec_detached()</a>. </p>

</div>
</div>
<a id="a571743f82fa29e9b687967e7d3195f4b" name="a571743f82fa29e9b687967e7d3195f4b"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a571743f82fa29e9b687967e7d3195f4b">&#9670;&#160;</a></span>t_cose_encrypt_dec_add_recipient()</h2>

<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">static void t_cose_encrypt_dec_add_recipient </td>
          <td>(</td>
          <td class="paramtype">struct <a class="el" href="structt__cose__encrypt__dec__ctx.html">t_cose_encrypt_dec_ctx</a> *&#160;</td>
          <td class="paramname"><em>context</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">struct <a class="el" href="structt__cose__recipient__dec.html">t_cose_recipient_dec</a> *&#160;</td>
          <td class="paramname"><em>recipient</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">inline</span><span class="mlabel">static</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p>Add a <code>COSE_Recipient</code> decryptor/decoder. </p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramdir">[in]</td><td class="paramname">context</td><td>Encrypted message decryption context. </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">recipient</td><td>Recipient decryptor/decoder object.</td></tr>
  </table>
  </dd>
</dl>
<p>See the various recipient implementations such as the ones for keywrap and HPKE.</p>
<p>This may be called multiple times to configure many <code>COSE_Recipient</code> decryptor/decoders. Many of the same type may be added for different keys with different key IDs. Many of different types may be added.</p>
<p>See <a class="el" href="t__cose__encrypt__dec_8h.html#ab3198cda334bf2ca09dc28318578a4d9" title="Decryption of a COSE_Encrypt0 or COSE_Encrypt structure.">t_cose_encrypt_dec()</a> for the details of each individual <a class="el" href="structt__cose__recipient__dec.html">t_cose_recipient_dec</a> is invoked in a loop on each COSE_Recipient. </p>

</div>
</div>
<a id="a55df1131285e920487980a0075367d24" name="a55df1131285e920487980a0075367d24"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a55df1131285e920487980a0075367d24">&#9670;&#160;</a></span>t_cose_encrypt_dec_detached()</h2>

<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">static enum <a class="el" href="t__cose__common_8h.html#a469580b586841b779bbdc430d3a0dd97">t_cose_err_t</a> t_cose_encrypt_dec_detached </td>
          <td>(</td>
          <td class="paramtype">struct <a class="el" href="structt__cose__encrypt__dec__ctx.html">t_cose_encrypt_dec_ctx</a> *&#160;</td>
          <td class="paramname"><em>context</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">QCBORDecodeContext *&#160;</td>
          <td class="paramname"><em>cbor_decoder</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">struct q_useful_buf_c&#160;</td>
          <td class="paramname"><em>ext_sup_data</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">struct q_useful_buf_c&#160;</td>
          <td class="paramname"><em>detached_ciphertext</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">struct q_useful_buf&#160;</td>
          <td class="paramname"><em>plaintext_buffer</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">struct q_useful_buf_c *&#160;</td>
          <td class="paramname"><em>plaintext</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">struct <a class="el" href="structt__cose__parameter.html">t_cose_parameter</a> **&#160;</td>
          <td class="paramname"><em>returned_parameters</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">inline</span><span class="mlabel">static</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p>Decrypt a <code>COSE_Encrypt0</code> or <code>COSE_Encrypt</code> with detached cipher text. </p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramdir">[in,out]</td><td class="paramname">context</td><td>The <a class="el" href="structt__cose__encrypt__dec__ctx.html">t_cose_encrypt_dec_ctx</a> context. </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">cbor_decoder</td><td>Source of the input COSE message to decrypt. </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">ext_sup_data</td><td>Externally supplied data or NULL_Q_USEFUL_BUF. </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">detached_ciphertext</td><td>The detached ciphertext. </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">plaintext_buffer</td><td>A buffer for plaintext. </td></tr>
    <tr><td class="paramdir">[out]</td><td class="paramname">plaintext</td><td>Place to return pointer and length of the plaintext. </td></tr>
    <tr><td class="paramdir">[out]</td><td class="paramname">returned_parameters</td><td>Place to return linked list of header parameters.</td></tr>
  </table>
  </dd>
</dl>
<dl class="section return"><dt>Returns</dt><dd>This returns one of the error codes defined by <a class="el" href="t__cose__common_8h.html#a469580b586841b779bbdc430d3a0dd97">t_cose_err_t</a>.</dd></dl>
<p>See <a class="el" href="t__cose__encrypt__dec_8h.html#ab3198cda334bf2ca09dc28318578a4d9" title="Decryption of a COSE_Encrypt0 or COSE_Encrypt structure.">t_cose_encrypt_dec()</a>. This works the same, except ciphertext for the COSE_Encrypt0 or COSE_Encrypt must be an encoded CBOR NULL. The payload is conveyed outside the COSE_Encrypt0 or COSE_Encrypt and passed in to <code>detached_ciphertext</code>. </p>

</div>
</div>
<a id="abb500c8d070af077f88486d441c15958" name="abb500c8d070af077f88486d441c15958"></a>
<h2 class="memtitle"><span class="permalink"><a href="#abb500c8d070af077f88486d441c15958">&#9670;&#160;</a></span>t_cose_encrypt_dec_init()</h2>

<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">static void t_cose_encrypt_dec_init </td>
          <td>(</td>
          <td class="paramtype">struct <a class="el" href="structt__cose__encrypt__dec__ctx.html">t_cose_encrypt_dec_ctx</a> *&#160;</td>
          <td class="paramname"><em>context</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">uint32_t&#160;</td>
          <td class="paramname"><em>option_flags</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">inline</span><span class="mlabel">static</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p>Initialize context to decrypt a <code>COSE_Encrypt</code> or <code>COSE_Encrypt0</code>. </p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramdir">[in]</td><td class="paramname">context</td><td>The context to initialize. </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">option_flags</td><td>Options controlling the encryption. Currently none.</td></tr>
  </table>
  </dd>
</dl>
<p>TODO: not all of the following is implemented If <code>option_flags</code> includes either T_COSE_OPT_MESSAGE_TYPE_ENCRYPT0 or T_COSE_OPT_MESSAGE_TYPE_ENCRYPT then the input message must be <code>COSE_Encrypt0</code> or <code>COSE_Encrypt</code> respectively. The error T_COSE_ERR_XXXXXX will be returned if the option_flags indicated <code>COSE_Encrypt0</code> and the input is <code>COSE_Encrypt</code> and vice versa. If <code>option_flags</code> are T_COSE_OPT_MESSAGE_TYPE_UNSPECIFIED (which is 0) then the message type will be determined by CBOR tag. If there is no tag then the error T_COSE_ERR_XXXXXX will be returned. The errors mentioned here are returned when <a class="el" href="t__cose__encrypt__dec_8h.html#ab3198cda334bf2ca09dc28318578a4d9" title="Decryption of a COSE_Encrypt0 or COSE_Encrypt structure.">t_cose_encrypt_dec()</a> is called.</p>
<p>When the message type is COSE_Encrypt0, <a class="el" href="t__cose__encrypt__dec_8h.html#afc801f8f66722926c37407cfc7cdae53" title="Set content encryption key for COSE_Encrypt0.">t_cose_encrypt_dec_set_cek()</a> must have been called to set the CEK and <a class="el" href="t__cose__encrypt__dec_8h.html#a571743f82fa29e9b687967e7d3195f4b" title="Add a COSE_Recipient decryptor/decoder.">t_cose_encrypt_dec_add_recipient()</a> must not have been called. When the message type is COSE_Encrypt, <a class="el" href="t__cose__encrypt__dec_8h.html#a571743f82fa29e9b687967e7d3195f4b" title="Add a COSE_Recipient decryptor/decoder.">t_cose_encrypt_dec_add_recipient()</a> must have been called at least once. <a class="el" href="t__cose__encrypt__dec_8h.html#afc801f8f66722926c37407cfc7cdae53" title="Set content encryption key for COSE_Encrypt0.">t_cose_encrypt_dec_set_cek()</a> can be called to explicitly set the CEK, but it rarely needed as the CEK is generated automatocally from the random number generator when it is not set. </p>

</div>
</div>
<a id="afc801f8f66722926c37407cfc7cdae53" name="afc801f8f66722926c37407cfc7cdae53"></a>
<h2 class="memtitle"><span class="permalink"><a href="#afc801f8f66722926c37407cfc7cdae53">&#9670;&#160;</a></span>t_cose_encrypt_dec_set_cek()</h2>

<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">static void t_cose_encrypt_dec_set_cek </td>
          <td>(</td>
          <td class="paramtype">struct <a class="el" href="structt__cose__encrypt__dec__ctx.html">t_cose_encrypt_dec_ctx</a> *&#160;</td>
          <td class="paramname"><em>context</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">struct <a class="el" href="structt__cose__key.html">t_cose_key</a>&#160;</td>
          <td class="paramname"><em>cek</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">inline</span><span class="mlabel">static</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p>Set content encryption key for <code>COSE_Encrypt0</code>. </p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramdir">[in]</td><td class="paramname">context</td><td>The <a class="el" href="structt__cose__encrypt__dec__ctx.html">t_cose_encrypt_dec_ctx</a> context. </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">cek</td><td>The content encryption key.</td></tr>
  </table>
  </dd>
</dl>
<p>This sets the content encryption key (the CEK). This must be called for COSE_Encrypt0 as there is no COSE_Recipient to provide the CEK. The type of the key must be appropriate for the content encryption algorithm for body of the COSE_Encrypt0. This may be obtained by.... TODO: implement decode-only mode to return header params</p>
<p>If called for COSE_Encrypt, this will be ignored as the CEK comes from the COSE_Recipient. </p>

</div>
</div>
</div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by&#160;<a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.8
</small></address>
</body>
</html>
