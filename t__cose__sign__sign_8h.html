<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.9.8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>t_cose: inc/t_cose/t_cose_sign_sign.h File Reference</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectalign">
   <div id="projectname">t_cose
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.8 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search/",'.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

<div id="nav-path" class="navpath">
  <ul>
<li class="navelem"><a class="el" href="dir_bfccd401955b95cf8c75461437045ac0.html">inc</a></li><li class="navelem"><a class="el" href="dir_c790dd4d93afe6413732f56f53ec2af4.html">t_cose</a></li>  </ul>
</div>
</div><!-- top -->
<div class="header">
  <div class="summary">
<a href="#nested-classes">Data Structures</a> &#124;
<a href="#define-members">Macros</a> &#124;
<a href="#func-members">Functions</a>  </div>
  <div class="headertitle"><div class="title">t_cose_sign_sign.h File Reference</div></div>
</div><!--header-->
<div class="contents">

<p>Create a <code>COSE_Sign</code> or <code>COSE_Sign1</code> message.  
<a href="#details">More...</a></p>
<div class="textblock"><code>#include &lt;stdint.h&gt;</code><br />
<code>#include &lt;stdbool.h&gt;</code><br />
<code>#include &quot;C:/Users/ADMIN/QCBOR/inc/qcbor/qcbor.h&quot;</code><br />
<code>#include &quot;C:/Users/ADMIN/t_cose/inc/t_cose/q_useful_buf.h&quot;</code><br />
<code>#include &quot;C:/Users/ADMIN/t_cose/inc/t_cose/t_cose_common.h&quot;</code><br />
<code>#include &quot;C:/Users/ADMIN/t_cose/inc/t_cose/t_cose_signature_sign.h&quot;</code><br />
<code>#include &quot;C:/Users/ADMIN/t_cose/inc/t_cose/t_cose_parameters.h&quot;</code><br />
</div>
<p><a href="t__cose__sign__sign_8h_source.html">Go to the source code of this file.</a></p>
<table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a id="nested-classes" name="nested-classes"></a>
Data Structures</h2></td></tr>
<tr class="memitem:"><td class="memItemLeft" align="right" valign="top">struct &#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="structt__cose__sign__sign__ctx.html">t_cose_sign_sign_ctx</a></td></tr>
<tr class="separator:"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table><table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a id="define-members" name="define-members"></a>
Macros</h2></td></tr>
<tr class="memitem:a83d4e7ad0c4ada63f17d4b1e8fa0cc56" id="r_a83d4e7ad0c4ada63f17d4b1e8fa0cc56"><td class="memItemLeft" align="right" valign="top"><a id="a83d4e7ad0c4ada63f17d4b1e8fa0cc56" name="a83d4e7ad0c4ada63f17d4b1e8fa0cc56"></a>
#define&#160;</td><td class="memItemRight" valign="bottom"><b>T_COSE_OPT_SHORT_CIRCUIT_SIG</b>&#160;&#160;&#160;0x00002000</td></tr>
<tr class="separator:a83d4e7ad0c4ada63f17d4b1e8fa0cc56"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table><table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a id="func-members" name="func-members"></a>
Functions</h2></td></tr>
<tr class="memitem:a966e66b5e6a0d62cdea29111da85a36a" id="r_a966e66b5e6a0d62cdea29111da85a36a"><td class="memItemLeft" align="right" valign="top">static void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="t__cose__sign__sign_8h.html#a966e66b5e6a0d62cdea29111da85a36a">t_cose_sign_sign_init</a> (struct <a class="el" href="structt__cose__sign__sign__ctx.html">t_cose_sign_sign_ctx</a> *context, uint32_t option_flags)</td></tr>
<tr class="memdesc:a966e66b5e6a0d62cdea29111da85a36a"><td class="mdescLeft">&#160;</td><td class="mdescRight">Initialize to start creating a <code>COSE_Sign1</code> or <code>COSE_Sign</code>.  <br /></td></tr>
<tr class="separator:a966e66b5e6a0d62cdea29111da85a36a"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a60ca5b230751c94fe18869041cea946e" id="r_a60ca5b230751c94fe18869041cea946e"><td class="memItemLeft" align="right" valign="top">static void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="t__cose__sign__sign_8h.html#a60ca5b230751c94fe18869041cea946e">t_cose_sign_add_signer</a> (struct <a class="el" href="structt__cose__sign__sign__ctx.html">t_cose_sign_sign_ctx</a> *context, struct <a class="el" href="structt__cose__signature__sign.html">t_cose_signature_sign</a> *signer)</td></tr>
<tr class="memdesc:a60ca5b230751c94fe18869041cea946e"><td class="mdescLeft">&#160;</td><td class="mdescRight">Add a signer that is configured with a key and algorithm ID.  <br /></td></tr>
<tr class="separator:a60ca5b230751c94fe18869041cea946e"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a463a830f06bc1e843b1e52b08bdbaf14" id="r_a463a830f06bc1e843b1e52b08bdbaf14"><td class="memItemLeft" align="right" valign="top">static void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="t__cose__sign__sign_8h.html#a463a830f06bc1e843b1e52b08bdbaf14">t_cose_sign_add_body_header_params</a> (struct <a class="el" href="structt__cose__sign__sign__ctx.html">t_cose_sign_sign_ctx</a> *context, struct <a class="el" href="structt__cose__parameter.html">t_cose_parameter</a> *parameters)</td></tr>
<tr class="memdesc:a463a830f06bc1e843b1e52b08bdbaf14"><td class="mdescLeft">&#160;</td><td class="mdescRight">Add body header parameters to the <code>COSE_Sign</code> or <code>COSE_Sign1</code>.  <br /></td></tr>
<tr class="separator:a463a830f06bc1e843b1e52b08bdbaf14"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a22670dab28938bb4180f482e2a2a66a6" id="r_a22670dab28938bb4180f482e2a2a66a6"><td class="memItemLeft" align="right" valign="top">static enum <a class="el" href="t__cose__common_8h.html#a469580b586841b779bbdc430d3a0dd97">t_cose_err_t</a>&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="t__cose__sign__sign_8h.html#a22670dab28938bb4180f482e2a2a66a6">t_cose_sign_sign</a> (struct <a class="el" href="structt__cose__sign__sign__ctx.html">t_cose_sign_sign_ctx</a> *context, struct q_useful_buf_c ext_sup_data, struct q_useful_buf_c payload, struct q_useful_buf out_buf, struct q_useful_buf_c *result)</td></tr>
<tr class="memdesc:a22670dab28938bb4180f482e2a2a66a6"><td class="mdescLeft">&#160;</td><td class="mdescRight">Create and sign a <code>COSE_Sign1</code> or <code>COSE_Sign</code> message.  <br /></td></tr>
<tr class="separator:a22670dab28938bb4180f482e2a2a66a6"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a572b6b7e97dcf6b0e7917f39431efdef" id="r_a572b6b7e97dcf6b0e7917f39431efdef"><td class="memItemLeft" align="right" valign="top">static enum <a class="el" href="t__cose__common_8h.html#a469580b586841b779bbdc430d3a0dd97">t_cose_err_t</a>&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="t__cose__sign__sign_8h.html#a572b6b7e97dcf6b0e7917f39431efdef">t_cose_sign_sign_detached</a> (struct <a class="el" href="structt__cose__sign__sign__ctx.html">t_cose_sign_sign_ctx</a> *context, struct q_useful_buf_c ext_sup_data, struct q_useful_buf_c detached_payload, struct q_useful_buf out_buf, struct q_useful_buf_c *result)</td></tr>
<tr class="memdesc:a572b6b7e97dcf6b0e7917f39431efdef"><td class="mdescLeft">&#160;</td><td class="mdescRight">Create and sign a <code>COSE_Sign1</code> or <code>COSE_Sign</code> message with detached payload.  <br /></td></tr>
<tr class="separator:a572b6b7e97dcf6b0e7917f39431efdef"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a7a31792ec77a174d53a220444beacbea" id="r_a7a31792ec77a174d53a220444beacbea"><td class="memItemLeft" align="right" valign="top">enum <a class="el" href="t__cose__common_8h.html#a469580b586841b779bbdc430d3a0dd97">t_cose_err_t</a>&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="t__cose__sign__sign_8h.html#a7a31792ec77a174d53a220444beacbea">t_cose_sign_encode_start</a> (struct <a class="el" href="structt__cose__sign__sign__ctx.html">t_cose_sign_sign_ctx</a> *context, QCBOREncodeContext *cbor_encoder)</td></tr>
<tr class="memdesc:a7a31792ec77a174d53a220444beacbea"><td class="mdescLeft">&#160;</td><td class="mdescRight">Output first part of a <code>COSE_Sign1</code> or <code>COSE_Sign</code> message.  <br /></td></tr>
<tr class="separator:a7a31792ec77a174d53a220444beacbea"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a28d8e3857f11abe0b50f0c9cbb1c9bae" id="r_a28d8e3857f11abe0b50f0c9cbb1c9bae"><td class="memItemLeft" align="right" valign="top">enum <a class="el" href="t__cose__common_8h.html#a469580b586841b779bbdc430d3a0dd97">t_cose_err_t</a>&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="t__cose__sign__sign_8h.html#a28d8e3857f11abe0b50f0c9cbb1c9bae">t_cose_sign_encode_finish</a> (struct <a class="el" href="structt__cose__sign__sign__ctx.html">t_cose_sign_sign_ctx</a> *context, struct q_useful_buf_c ext_sup_data, struct q_useful_buf_c signed_payload, QCBOREncodeContext *cbor_encoder)</td></tr>
<tr class="memdesc:a28d8e3857f11abe0b50f0c9cbb1c9bae"><td class="mdescLeft">&#160;</td><td class="mdescRight">Finish a <code>COSE_Sign1</code> or <code>COSE_Sign</code> message by outputting the signature.  <br /></td></tr>
<tr class="separator:a28d8e3857f11abe0b50f0c9cbb1c9bae"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a2272bfaebae498274ff8c6c916bd1085" id="r_a2272bfaebae498274ff8c6c916bd1085"><td class="memItemLeft" align="right" valign="top">enum <a class="el" href="t__cose__common_8h.html#a469580b586841b779bbdc430d3a0dd97">t_cose_err_t</a>&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="t__cose__sign__sign_8h.html#a2272bfaebae498274ff8c6c916bd1085">t_cose_sign_sign_private</a> (struct <a class="el" href="structt__cose__sign__sign__ctx.html">t_cose_sign_sign_ctx</a> *context, bool payload_is_detached, struct q_useful_buf_c ext_sup_data, struct q_useful_buf_c payload, struct q_useful_buf out_buf, struct q_useful_buf_c *result)</td></tr>
<tr class="memdesc:a2272bfaebae498274ff8c6c916bd1085"><td class="mdescLeft">&#160;</td><td class="mdescRight">Semi-private function that does a complete signing in one call.  <br /></td></tr>
<tr class="separator:a2272bfaebae498274ff8c6c916bd1085"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table>
<a name="details" id="details"></a><h2 class="groupheader">Detailed Description</h2>
<div class="textblock"><p>Create a <code>COSE_Sign</code> or <code>COSE_Sign1</code> message. </p>
<p>This creates a <code>COSE_Sign1</code> or <code>COSE_Sign</code> message in compliance with <a href="https://tools.ietf.org/html/rfc9052">COSE (RFC 9052)</a>. A <code>COSE_Sign1</code> or <code>COSE_Sign</code> message is a CBOR-encoded binary blob that contains a payload that is to be authenticated, header parameters that carry things like the algorithm and key ID and a signature or signatures. Since it is CBOR, it is compact with low overhead and simple to decode.</p>
<p>This implementation is in the form of an "object" called <code>t_cose_sign_sign</code>. The object is constituted of a signing context data structure and functions that operate on it. Further, this object delegates the actual signing to another object called <code><a class="el" href="structt__cose__signature__sign.html">t_cose_signature_sign</a></code>. This is to accommodate different signing algorithms and schemes in a runtime pluggable manner. No modification of the source code for <code>t_cose_sign_sign</code> is required to add new algorithms.</p>
<p>This can be used in one of two ways.</p>
<p>The first and simplest does the bulk of the work in one call, <a class="el" href="t__cose__sign__sign_8h.html#a22670dab28938bb4180f482e2a2a66a6" title="Create and sign a COSE_Sign1 or COSE_Sign message.">t_cose_sign_sign()</a>. It requires the payload be supplied in a single contiguous buffer and outputs the COSE message to a single contiguous buffer. This results in two copies of the payload in memory.</p>
<p>The second way uses two calls, <a class="el" href="t__cose__sign__sign_8h.html#a7a31792ec77a174d53a220444beacbea" title="Output first part of a COSE_Sign1 or COSE_Sign message.">t_cose_sign_encode_start()</a> and <a class="el" href="t__cose__sign__sign_8h.html#a28d8e3857f11abe0b50f0c9cbb1c9bae" title="Finish a COSE_Sign1 or COSE_Sign message by outputting the signature.">t_cose_sign_encode_finish()</a>. Between the two calls the payload can be output to the CBOR encoder resulting in only one copy of the payload memory.</p>
<p>This has a mode that can calculate the size of the output buffer for the COSE message.</p>
<p>This is a largely complete implementation of COSE signing. It accommodates detached signatures and externally supplied data.</p>
<p>This replaces t_cose_sign1_sign which supported only COSE_Sign1. </p>
</div><h2 class="groupheader">Function Documentation</h2>
<a id="a463a830f06bc1e843b1e52b08bdbaf14" name="a463a830f06bc1e843b1e52b08bdbaf14"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a463a830f06bc1e843b1e52b08bdbaf14">&#9670;&#160;</a></span>t_cose_sign_add_body_header_params()</h2>

<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">static void t_cose_sign_add_body_header_params </td>
          <td>(</td>
          <td class="paramtype">struct <a class="el" href="structt__cose__sign__sign__ctx.html">t_cose_sign_sign_ctx</a> *&#160;</td>
          <td class="paramname"><em>context</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">struct <a class="el" href="structt__cose__parameter.html">t_cose_parameter</a> *&#160;</td>
          <td class="paramname"><em>parameters</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">inline</span><span class="mlabel">static</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p>Add body header parameters to the <code>COSE_Sign</code> or <code>COSE_Sign1</code>. </p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramdir">[in]</td><td class="paramname">context</td><td>The signing context. </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">parameters</td><td>Linked list of parameters to add.</td></tr>
  </table>
  </dd>
</dl>
<p>This adds parameters to the <code>COSE_Sign1</code> or <code>COSE_Sign</code> body. Signature parameters in <code>COSE_Signatures</code> in <code>COSE_Sign</code> are handed through <a class="el" href="structt__cose__signature__sign.html">t_cose_signature_sign</a>.</p>
<p>For simple use cases, it is unnecessary to call this as the algorithm ID is automatically added.</p>
<p>It is unnecessary to call this to add the kid either. The kid is added by configuring the <a class="el" href="structt__cose__signature__sign.html">t_cose_signature_sign</a>.</p>
<p>This is typically called only once as subsequent calls do not accumulate a linked list.</p>
<p>This adds a linked list of <a class="el" href="structt__cose__parameter.html">t_cose_parameter</a>. Each node is filled in with the label, type, value, criticality and protectedness of the parameter. Integer and string values go in the list node. Other types are allowed through a parameter encode callback. Only integer parameter labels are supported (so far).</p>
<p>This mechanism replaces <a class="el" href="t__cose__sign1__sign_8h.html#a427a709f9a3caca969fb88992a412be3" title="Set the payload content type using CoAP content types.">t_cose_sign1_set_content_type_uint()</a> and <a class="el" href="t__cose__sign1__sign_8h.html#a92ea915477a67077690dea34687e8565" title="Set the payload content type using MIME content types.">t_cose_sign1_set_content_type_tstr()</a> that is used by t_cose_sign1. </p>

</div>
</div>
<a id="a60ca5b230751c94fe18869041cea946e" name="a60ca5b230751c94fe18869041cea946e"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a60ca5b230751c94fe18869041cea946e">&#9670;&#160;</a></span>t_cose_sign_add_signer()</h2>

<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">static void t_cose_sign_add_signer </td>
          <td>(</td>
          <td class="paramtype">struct <a class="el" href="structt__cose__sign__sign__ctx.html">t_cose_sign_sign_ctx</a> *&#160;</td>
          <td class="paramname"><em>context</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">struct <a class="el" href="structt__cose__signature__sign.html">t_cose_signature_sign</a> *&#160;</td>
          <td class="paramname"><em>signer</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">inline</span><span class="mlabel">static</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p>Add a signer that is configured with a key and algorithm ID. </p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramdir">[in]</td><td class="paramname">context</td><td>The signing context. </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">signer</td><td>An initialized instance of <a class="el" href="structt__cose__signature__sign.html">t_cose_signature_sign</a>.</td></tr>
  </table>
  </dd>
</dl>
<p>Call this at least once to configure one or more signers. The signer, an instance of <a class="el" href="structt__cose__signature__sign.html">t_cose_signature_sign</a>, is an object configured with the signing algorithm, signing key and related and computes the actual signature.</p>
<p>When producing a <code>COSE_Sign1</code>, this must be called only once. When producing a <code>COSE_Sign</code>, this must be called at least once, but can be called many more times if there are to be multiple signatures. Note that each added signer can be with for a different key and/or different signer implementation for a different algorithm.</p>
<p>This must be called with a concrete instance, such as a <a class="el" href="structt__cose__signature__sign__main.html">t_cose_signature_sign_main</a>. The concrete instance must be configured with a key and algorithm ID before this is called. Several signers are part of t_cose, but the caller may also design and implement their own. </p>

</div>
</div>
<a id="a28d8e3857f11abe0b50f0c9cbb1c9bae" name="a28d8e3857f11abe0b50f0c9cbb1c9bae"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a28d8e3857f11abe0b50f0c9cbb1c9bae">&#9670;&#160;</a></span>t_cose_sign_encode_finish()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">enum <a class="el" href="t__cose__common_8h.html#a469580b586841b779bbdc430d3a0dd97">t_cose_err_t</a> t_cose_sign_encode_finish </td>
          <td>(</td>
          <td class="paramtype">struct <a class="el" href="structt__cose__sign__sign__ctx.html">t_cose_sign_sign_ctx</a> *&#160;</td>
          <td class="paramname"><em>context</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">struct q_useful_buf_c&#160;</td>
          <td class="paramname"><em>ext_sup_data</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">struct q_useful_buf_c&#160;</td>
          <td class="paramname"><em>signed_payload</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">QCBOREncodeContext *&#160;</td>
          <td class="paramname"><em>cbor_encoder</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Finish a <code>COSE_Sign1</code> or <code>COSE_Sign</code> message by outputting the signature. </p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramdir">[in]</td><td class="paramname">context</td><td>The signing context. </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">ext_sup_data</td><td>Externally supplied data or <code>NULL_Q_USEFUL_BUF_C</code>. </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">signed_payload</td><td>The detached payload or <code>NULL_Q_USEFUL_BUF_C</code>. </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">cbor_encoder</td><td>Encoding context to output to.</td></tr>
  </table>
  </dd>
</dl>
<dl class="section return"><dt>Returns</dt><dd>This returns one of the error codes defined by <a class="el" href="t__cose__common_8h.html#a469580b586841b779bbdc430d3a0dd97">t_cose_err_t</a>.</dd></dl>
<p>Call this to complete a signed message started with <a class="el" href="t__cose__sign__sign_8h.html#a7a31792ec77a174d53a220444beacbea" title="Output first part of a COSE_Sign1 or COSE_Sign message.">t_cose_sign_encode_start()</a>.</p>
<p>This is when the callback into the <a class="el" href="structt__cose__signature__sign.html">t_cose_signature_sign</a> object(s) is(are) called and when cryptographic signature algorithm is run.</p>
<p>See <a class="el" href="t__cose__sign__sign_8h.html#a22670dab28938bb4180f482e2a2a66a6" title="Create and sign a COSE_Sign1 or COSE_Sign message.">t_cose_sign_sign()</a> for a detailed description of <code>ext_sup_data</code>.</p>
<p>The completed COSE message is retrieved from the <code>cbor_encoder</code> by calling <code>QCBOREncode_Finish()</code>. Check the return value from QCBOREncode_Finish() to be sure there were no encoding errors. </p>

</div>
</div>
<a id="a7a31792ec77a174d53a220444beacbea" name="a7a31792ec77a174d53a220444beacbea"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a7a31792ec77a174d53a220444beacbea">&#9670;&#160;</a></span>t_cose_sign_encode_start()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">enum <a class="el" href="t__cose__common_8h.html#a469580b586841b779bbdc430d3a0dd97">t_cose_err_t</a> t_cose_sign_encode_start </td>
          <td>(</td>
          <td class="paramtype">struct <a class="el" href="structt__cose__sign__sign__ctx.html">t_cose_sign_sign_ctx</a> *&#160;</td>
          <td class="paramname"><em>context</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">QCBOREncodeContext *&#160;</td>
          <td class="paramname"><em>cbor_encoder</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Output first part of a <code>COSE_Sign1</code> or <code>COSE_Sign</code> message. </p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramdir">[in]</td><td class="paramname">context</td><td>The signing context. </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">cbor_encoder</td><td>Encoding context to output to.</td></tr>
  </table>
  </dd>
</dl>
<p>This is the more complex and more memory efficient alternative to <a class="el" href="t__cose__sign__sign_8h.html#a22670dab28938bb4180f482e2a2a66a6" title="Create and sign a COSE_Sign1 or COSE_Sign message.">t_cose_sign_sign()</a>. Like <a class="el" href="t__cose__sign__sign_8h.html#a22670dab28938bb4180f482e2a2a66a6" title="Create and sign a COSE_Sign1 or COSE_Sign message.">t_cose_sign_sign()</a>, <a class="el" href="t__cose__sign__sign_8h.html#a966e66b5e6a0d62cdea29111da85a36a" title="Initialize to start creating a COSE_Sign1 or COSE_Sign.">t_cose_sign_sign_init()</a> and <a class="el" href="t__cose__sign__sign_8h.html#a60ca5b230751c94fe18869041cea946e" title="Add a signer that is configured with a key and algorithm ID.">t_cose_sign_add_signer()</a> must be called before calling this.</p>
<p>When this is called, the first parts of the <code>COSE_Sign1</code> or <code>COSE_Sign</code> message are output to the <code>cbor_encoder</code>.</p>
<p>After this is call completes, the payload must be written to the <code>cbor_encoder</code>. If payload is detached, add a CBOR NULL by calling QCBOREncode_AddNULL(). If the payload is not CBOR or has already been CBOR-encoded, add it with QCBOREncode_AddBytes(). To CBOR encode the payload directly into the output buffer call QCBOREncode_BstrWrap(), call the various QCBOR Add functions and then call QCBOREncode_CloseBstrWrap2(). Note that this last call will return a q_useful_buf_c with the encoded payload.</p>
<p>To complete the COSE message call <a class="el" href="t__cose__sign__sign_8h.html#a28d8e3857f11abe0b50f0c9cbb1c9bae" title="Finish a COSE_Sign1 or COSE_Sign message by outputting the signature.">t_cose_sign_encode_finish()</a>, passing the payload whether it is detached or not. Here the payload is only used as input to the signature algorithm.</p>
<p>The <code>cbor_encoder</code> must have been initialized with an output buffer to hold the <code>COSE_Sign1</code> or <code>COSE_Sign</code> header parameters, the payload (if not detached) and the signature(s).</p>
<p>This and <a class="el" href="t__cose__sign__sign_8h.html#a28d8e3857f11abe0b50f0c9cbb1c9bae" title="Finish a COSE_Sign1 or COSE_Sign message by outputting the signature.">t_cose_sign_encode_finish()</a> can be used to calculate the size of the output message n the way <code>QCBOREncode</code> is usually used to calculate sizes. In this case the <code>t_cose_sign_ctx</code> must be initialized with the options, signer and additional header parameters just as normal as these are needed to calculate the size. Then set up the output buffer for <code>cbor_encoder</code> with a <code><code>NULL</code> pointer</code> and large length like <code>UINT32_MAX</code>. Call <a class="el" href="t__cose__sign__sign_8h.html#a7a31792ec77a174d53a220444beacbea" title="Output first part of a COSE_Sign1 or COSE_Sign message.">t_cose_sign_encode_start()</a>, then format the payload into the encoder context, then call <a class="el" href="t__cose__sign__sign_8h.html#a28d8e3857f11abe0b50f0c9cbb1c9bae" title="Finish a COSE_Sign1 or COSE_Sign message by outputting the signature.">t_cose_sign_encode_finish()</a>. Finally call <code>QCBOREncode_FinishGetSize()</code> to get the length. </p>

</div>
</div>
<a id="a22670dab28938bb4180f482e2a2a66a6" name="a22670dab28938bb4180f482e2a2a66a6"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a22670dab28938bb4180f482e2a2a66a6">&#9670;&#160;</a></span>t_cose_sign_sign()</h2>

<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">static enum <a class="el" href="t__cose__common_8h.html#a469580b586841b779bbdc430d3a0dd97">t_cose_err_t</a> t_cose_sign_sign </td>
          <td>(</td>
          <td class="paramtype">struct <a class="el" href="structt__cose__sign__sign__ctx.html">t_cose_sign_sign_ctx</a> *&#160;</td>
          <td class="paramname"><em>context</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">struct q_useful_buf_c&#160;</td>
          <td class="paramname"><em>ext_sup_data</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">struct q_useful_buf_c&#160;</td>
          <td class="paramname"><em>payload</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">struct q_useful_buf&#160;</td>
          <td class="paramname"><em>out_buf</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">struct q_useful_buf_c *&#160;</td>
          <td class="paramname"><em>result</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">inline</span><span class="mlabel">static</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p>Create and sign a <code>COSE_Sign1</code> or <code>COSE_Sign</code> message. </p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramdir">[in]</td><td class="paramname">context</td><td>The signing context. </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">ext_sup_data</td><td>Externally supplied data or <code>NULL_Q_USEFUL_BUF_C</code>. </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">payload</td><td>Pointer and length of payload to sign. </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">out_buf</td><td>Pointer and length of buffer to output to. </td></tr>
    <tr><td class="paramdir">[out]</td><td class="paramname">result</td><td>Pointer and length of the resulting message.</td></tr>
  </table>
  </dd>
</dl>
<p>The <code>context</code> must have been initialized with <a class="el" href="t__cose__sign__sign_8h.html#a966e66b5e6a0d62cdea29111da85a36a" title="Initialize to start creating a COSE_Sign1 or COSE_Sign.">t_cose_sign_sign_init()</a> and a signer object with a signing key added using <a class="el" href="t__cose__sign__sign_8h.html#a60ca5b230751c94fe18869041cea946e" title="Add a signer that is configured with a key and algorithm ID.">t_cose_sign_add_signer()</a>.</p>
<p>This creates the COSE header parameter, hashes and signs the payload and creates the signature all in one go. <code>out_buf</code> gives the pointer and length of the memory into which the output is written. The pointer and length of the completed message is returned in <code>result</code>.</p>
<p>The externally supplied data simply any data that should also be covered by the signature as described in section 4.3 of RFC 9052. The verifier of the message must also have exactly this data to be able to successfully verify the signature. Often this data is some parameters or fields in the protocol carrying the COSE message. For many use cases there is none and <code>ext_sup_data</code> is <code>NULL_Q_USEFUL_BUF_C</code>.</p>
<p>The size of <code>out_buf</code> must be the size of the payload plus overhead for formating, the signature and any added parameters like the key id and content type (if used). The COSE standard formatting overhead is minimal at about 30 bytes.For example, total overhead is about 150 bytes for an ECDSA 256 signature with a 32-byte key ID.</p>
<p>To compute the size of the buffer needed before it is allocated call this with <code>out_buf</code> containing a <code>NULL</code> pointer and large length like <code>UINT32_MAX</code>. The algorithm, key, kid and such must be set up just as if the real COSE message were to be created as these values are needed to compute the size correctly. The contents of <code>result</code> will be a <code>NULL</code> pointer and the length of the COSE message. When run like this, the cryptographic functions will not actually run, but the size of their output will be taken into account to give an exact size.</p>
<p>It is also possible to not do the size calculation if the size can be reliably estimated. Perhaps no kid or other header parameters are used and the algorithm is fixed. It is always safe to do this because t_cose will never write off the end of the output buffer. If the message is too long, <a class="el" href="t__cose__common_8h.html#a469580b586841b779bbdc430d3a0dd97a6944828acdfc4abfea5f73be83c3f60c">T_COSE_ERR_TOO_SMALL</a> will be returned.</p>
<p>This function requires the input payload to be complete and contiguous in a buffer. The resulting COSE message also contains the payload preceded by the header parameters and followed by the signature. This function thus requires two copies of the payload to be in memory. Alternatively <a class="el" href="t__cose__sign__sign_8h.html#a7a31792ec77a174d53a220444beacbea" title="Output first part of a COSE_Sign1 or COSE_Sign message.">t_cose_sign_encode_start()</a> and <a class="el" href="t__cose__sign__sign_8h.html#a28d8e3857f11abe0b50f0c9cbb1c9bae" title="Finish a COSE_Sign1 or COSE_Sign message by outputting the signature.">t_cose_sign_encode_finish()</a> can be used. They are more complex to use, but avoid the two copies of the payload and can reduce memory requirements by close to half. </p>

</div>
</div>
<a id="a572b6b7e97dcf6b0e7917f39431efdef" name="a572b6b7e97dcf6b0e7917f39431efdef"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a572b6b7e97dcf6b0e7917f39431efdef">&#9670;&#160;</a></span>t_cose_sign_sign_detached()</h2>

<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">static enum <a class="el" href="t__cose__common_8h.html#a469580b586841b779bbdc430d3a0dd97">t_cose_err_t</a> t_cose_sign_sign_detached </td>
          <td>(</td>
          <td class="paramtype">struct <a class="el" href="structt__cose__sign__sign__ctx.html">t_cose_sign_sign_ctx</a> *&#160;</td>
          <td class="paramname"><em>context</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">struct q_useful_buf_c&#160;</td>
          <td class="paramname"><em>ext_sup_data</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">struct q_useful_buf_c&#160;</td>
          <td class="paramname"><em>detached_payload</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">struct q_useful_buf&#160;</td>
          <td class="paramname"><em>out_buf</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">struct q_useful_buf_c *&#160;</td>
          <td class="paramname"><em>result</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">inline</span><span class="mlabel">static</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p>Create and sign a <code>COSE_Sign1</code> or <code>COSE_Sign</code> message with detached payload. </p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramdir">[in]</td><td class="paramname">context</td><td>The signing context. </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">ext_sup_data</td><td>Externally supplied data or <code>NULL_Q_USEFUL_BUF_C</code>. </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">detached_payload</td><td>Pointer and length of the detached payload to sign. </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">out_buf</td><td>Pointer and length of buffer to output to. </td></tr>
    <tr><td class="paramdir">[out]</td><td class="paramname">result</td><td>Pointer and length of the resulting message.</td></tr>
  </table>
  </dd>
</dl>
<p>This is similar to, but not the same as <a class="el" href="t__cose__sign__sign_8h.html#a22670dab28938bb4180f482e2a2a66a6" title="Create and sign a COSE_Sign1 or COSE_Sign message.">t_cose_sign_sign()</a>. Here the payload is detached and conveyed separately. The signature is still over the payload as with <a class="el" href="t__cose__sign__sign_8h.html#a22670dab28938bb4180f482e2a2a66a6" title="Create and sign a COSE_Sign1 or COSE_Sign message.">t_cose_sign_sign()</a>. The payload must be conveyed to recipient by some other means than by being inside the <code>COSE_Sign1</code> or <code>COSE_Sign</code>. The recipient will be unable to verify the received message without it. </p>

</div>
</div>
<a id="a966e66b5e6a0d62cdea29111da85a36a" name="a966e66b5e6a0d62cdea29111da85a36a"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a966e66b5e6a0d62cdea29111da85a36a">&#9670;&#160;</a></span>t_cose_sign_sign_init()</h2>

<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">static void t_cose_sign_sign_init </td>
          <td>(</td>
          <td class="paramtype">struct <a class="el" href="structt__cose__sign__sign__ctx.html">t_cose_sign_sign_ctx</a> *&#160;</td>
          <td class="paramname"><em>context</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">uint32_t&#160;</td>
          <td class="paramname"><em>option_flags</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">inline</span><span class="mlabel">static</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p>Initialize to start creating a <code>COSE_Sign1</code> or <code>COSE_Sign</code>. </p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramdir">[in]</td><td class="paramname">context</td><td>The signing context. </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">option_flags</td><td>One of <code>T_COSE_OPT_XXXX</code>.</td></tr>
  </table>
  </dd>
</dl>
<p>This initializes the <a class="el" href="structt__cose__sign__sign__ctx.html">t_cose_sign_sign_ctx</a> context. Either T_COSE_OPT_MESSAGE_TYPE_SIGN1 or T_COSE_OPT_MESSAGE_TYPE_SIGN must be given in <code>option_flags</code> to indicate which COSE message to produce.</p>
<p>A <code>COSE_Sign1</code> is simple having only one signature. <a class="el" href="t__cose__sign__sign_8h.html#a60ca5b230751c94fe18869041cea946e" title="Add a signer that is configured with a key and algorithm ID.">t_cose_sign_add_signer()</a> should be called only once for it. A <code>COSE_Sign</code> can have multiple signatures using different algorithms for different recipients. <a class="el" href="t__cose__sign__sign_8h.html#a60ca5b230751c94fe18869041cea946e" title="Add a signer that is configured with a key and algorithm ID.">t_cose_sign_add_signer()</a> can be called one more more times.</p>
<p><a class="el" href="t__cose__common_8h.html#a5ee410eed263e483e21a982c3c19a73d">T_COSE_OPT_OMIT_CBOR_TAG</a> can be or'd into <code>option_flags</code> if the CBOR tag for <code>COSE_Sign1</code>, 18, or the tag for <code>COSE_SIgn</code>, 98, is to be omitted.</p>
<p>The signature algorithm or algorithms are configured in the <a class="el" href="structt__cose__signature__sign.html">t_cose_signature_sign</a> instance or instances. </p>

</div>
</div>
<a id="a2272bfaebae498274ff8c6c916bd1085" name="a2272bfaebae498274ff8c6c916bd1085"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a2272bfaebae498274ff8c6c916bd1085">&#9670;&#160;</a></span>t_cose_sign_sign_private()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">enum <a class="el" href="t__cose__common_8h.html#a469580b586841b779bbdc430d3a0dd97">t_cose_err_t</a> t_cose_sign_sign_private </td>
          <td>(</td>
          <td class="paramtype">struct <a class="el" href="structt__cose__sign__sign__ctx.html">t_cose_sign_sign_ctx</a> *&#160;</td>
          <td class="paramname"><em>context</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">bool&#160;</td>
          <td class="paramname"><em>payload_is_detached</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">struct q_useful_buf_c&#160;</td>
          <td class="paramname"><em>ext_sup_data</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">struct q_useful_buf_c&#160;</td>
          <td class="paramname"><em>payload</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">struct q_useful_buf&#160;</td>
          <td class="paramname"><em>out_buf</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">struct q_useful_buf_c *&#160;</td>
          <td class="paramname"><em>result</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Semi-private function that does a complete signing in one call. </p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramdir">[in]</td><td class="paramname">context</td><td>The signing context. </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">payload_is_detached</td><td>If <code>true</code>, then <code>payload</code> is detached. </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">payload</td><td>The payload, inline or detached. </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">ext_sup_data</td><td>Externally supplied data or <code>NULL_Q_USEFUL_BUF_C</code>. </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">out_buf</td><td>Pointer and length of buffer to output to. </td></tr>
    <tr><td class="paramdir">[out]</td><td class="paramname">result</td><td>Pointer and length of the resulting message.</td></tr>
  </table>
  </dd>
</dl>
<dl class="section return"><dt>Returns</dt><dd>This returns one of the error codes defined by <a class="el" href="t__cose__common_8h.html#a469580b586841b779bbdc430d3a0dd97">t_cose_err_t</a>.</dd></dl>
<p>This is where the work actually gets done for signing that is done all in one call with or without externally supplied data and for included or detached payloads.</p>
<p>This is a private function internal to the implementation. Call <a class="el" href="t__cose__sign__sign_8h.html#a22670dab28938bb4180f482e2a2a66a6" title="Create and sign a COSE_Sign1 or COSE_Sign message.">t_cose_sign_sign()</a> or <a class="el" href="t__cose__sign__sign_8h.html#a572b6b7e97dcf6b0e7917f39431efdef" title="Create and sign a COSE_Sign1 or COSE_Sign message with detached payload.">t_cose_sign_sign_detached()</a> instead of this. </p>

</div>
</div>
</div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by&#160;<a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.8
</small></address>
</body>
</html>
